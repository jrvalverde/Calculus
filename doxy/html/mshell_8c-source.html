<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mshell.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>mshell.c</h1><a href="mshell_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*--------------------------------------------------------------------------</span>
00002 <span class="comment"> *</span>
00003 <span class="comment"> *  mshell.c -- Memory management utilities</span>
00004 <span class="comment"> *  Description: mshell.c contains routines to protect the programmer</span>
00005 <span class="comment"> *  from errors in calling memory allocation/free routines. The standard</span>
00006 <span class="comment"> *  library calls supported are: malloc, realloc, strdup, free</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *  The interface header mshell.h redefines these standard library</span>
00009 <span class="comment"> *  calls as macros. When the client code is compiled, the macros expand</span>
00010 <span class="comment"> *  to calls to this module. This module then calls the system memory</span>
00011 <span class="comment"> *  routines, ith additional error checking.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *  The allocation routines in this module add a data structure to the</span>
00014 <span class="comment"> *  top of allocated memory blocks which tag them as legal memory blocks.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *  When the free routine is called, the memory block to be freed is</span>
00017 <span class="comment"> *  checked for legality. If the block is not legal, the memory list</span>
00018 <span class="comment"> *  is dumped to stderr and the program is terminated.</span>
00019 <span class="comment"> *</span>
00020 <span class="comment"> *  Compilation options:</span>
00021 <span class="comment"> *  MEM_LIST    Link all allocated memory blocks onto an internal list.</span>
00022 <span class="comment"> *      The list can be displayed using Mem_Display().</span>
00023 <span class="comment"> *  MEM_WHERE   Save the file/line number of allocated blocks in header.</span>
00024 <span class="comment"> *      Requires that compiler supports __FILE__ and __LINE__ preprocessor</span>
00025 <span class="comment"> *      directives and __FILE__ string have static or global scope.</span>
00026 <span class="comment"> *  Problems: If you have any problems with this module, please contact:</span>
00027 <span class="comment"> *      Jim Schimandle, Primary Syncretics, 473 Sapena Court, Suite #6,</span>
00028 <span class="comment"> *      Santa Clara, CA 95054, Tel: (408)988-3818, Fax: (408)727-9891</span>
00029 <span class="comment"> *</span>
00030 <span class="comment"> */</span>
00031 
<a name="l00032"></a><a class="code" href="mshell_8c.html#a0">00032</a> <span class="preprocessor">#define __MSHELL__</span>
00033 <span class="preprocessor"></span>
00034 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00035 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00036 <span class="preprocessor">#include &lt;string.h&gt;</span>
00037 
00038 <span class="preprocessor">#include "<a class="code" href="mshell_8h.html">mshell.h</a>"</span>
00039 
00040 <span class="comment">/* Constants */</span>
<a name="l00041"></a><a class="code" href="mshell_8c.html#a1">00041</a> <span class="preprocessor">#define MEMTAG  0xa55a          </span><span class="comment">/* value for mh_tag */</span>
00042 
00043 <span class="comment">/* Structures */</span>
<a name="l00044"></a><a class="code" href="structmemnod.html">00044</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structmemnod.html">memnod</a>                   <span class="comment">/* Memory block header info     */</span>
00045 {                                       <span class="comment">/*------------------------------*/</span>
<a name="l00046"></a><a class="code" href="structmemnod.html#m0">00046</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        <a class="code" href="structmemnod.html#m0">mh_tag</a>;         <span class="comment">/* Special ident tag            */</span>
<a name="l00047"></a><a class="code" href="structmemnod.html#m1">00047</a>     size_t              <a class="code" href="structmemnod.html#m1">mh_size</a>;        <span class="comment">/* Size of allocation block     */</span>
00048 <span class="preprocessor">#if defined(MEM_LIST)</span>
<a name="l00049"></a><a class="code" href="structmemnod.html#m2">00049</a> <span class="preprocessor"></span>    <span class="keyword">struct </span><a class="code" href="structmemnod.html">memnod</a>       *mh_next;       <span class="comment">/* Next memory block            */</span>
<a name="l00050"></a><a class="code" href="structmemnod.html#m3">00050</a>     <span class="keyword">struct </span><a class="code" href="structmemnod.html">memnod</a>       *mh_prev;       <span class="comment">/* Previous memory block        */</span>
00051 <span class="preprocessor">#endif</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#if defined(MEM_WHERE)</span>
<a name="l00053"></a><a class="code" href="structmemnod.html#m4">00053</a> <span class="preprocessor"></span>    <span class="keywordtype">char</span>                *<a class="code" href="structmemnod.html#m4">mh_file</a>;       <span class="comment">/* File allocation was from     */</span>
<a name="l00054"></a><a class="code" href="structmemnod.html#m5">00054</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        <a class="code" href="structmemnod.html#m5">mh_line</a>;        <span class="comment">/* Line allocation was from     */</span>
00055 <span class="preprocessor">#endif</span>
00056 <span class="preprocessor"></span>} <a class="code" href="structmemnod.html">MEMHDR</a>;
00057 
00058 <span class="comment">/*  Alignment macros -- The macro ALIGN_SIZE defines size of the largest</span>
00059 <span class="comment"> *  object that must be aligned on your processor. the RESERVE_SIZE macro</span>
00060 <span class="comment"> *  calculates the nearest multiple of ALIGN_SIZE that is larger than the</span>
00061 <span class="comment"> *  memory block header. Change ALIGN_SIZE to match alignment requirements</span>
00062 <span class="comment"> *  of your processor</span>
00063 <span class="comment"> */</span>
<a name="l00064"></a><a class="code" href="mshell_8c.html#a2">00064</a> <span class="preprocessor">#define ALIGN_SIZE      sizeof(double)</span>
00065 <span class="preprocessor"></span>
<a name="l00066"></a><a class="code" href="mshell_8c.html#a3">00066</a> <span class="preprocessor">#define HDR_SIZE        sizeof(MEMHDR)</span>
<a name="l00067"></a><a class="code" href="mshell_8c.html#a4">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define RESERVE_SIZE    (((HDR_SIZE + (ALIGN_SIZE-1)) / ALIGN_SIZE) \</span>
00068 <span class="preprocessor">* ALIGN_SIZE)</span>
00069 <span class="preprocessor"></span>
00070 <span class="comment">/*  Conversion macros -- These macros convert the internal pointer</span>
00071 <span class="comment"> *  to a memory block header to/from the pointer used by the client code.</span>
00072 <span class="comment"> */</span>
<a name="l00073"></a><a class="code" href="mshell_8c.html#a5">00073</a> <span class="preprocessor">#define CLIENT_2_HDR(a) ((MEMHDR *)  (((char *) (a)) - RESERVE_SIZE))</span>
<a name="l00074"></a><a class="code" href="mshell_8c.html#a6">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define HDR_2_CLIENT(a) ((void *)  (((char *) (a)) + RESERVE_SIZE))</span>
00075 <span class="preprocessor"></span>
00076 <span class="comment">/* Local variables */</span>
<a name="l00077"></a><a class="code" href="mshell_8c.html#a9">00077</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>    <a class="code" href="mshell_8c.html#a9">mem_size</a> = 0;   <span class="comment">/* Amount of memory used */</span>
00078 <span class="preprocessor">#if defined(MEM_LIST)</span>
<a name="l00079"></a><a class="code" href="mshell_8c.html#a10">00079</a> <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="structmemnod.html">MEMHDR</a>   *<a class="code" href="mshell_8c.html#a10">memlist</a> = NULL;        <span class="comment">/* List of memory blocks */</span>
00080 <span class="preprocessor">#endif</span>
00081 <span class="preprocessor"></span>
00082 
00083 <span class="comment">/* Local functions */</span>
00084 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mshell_8c.html#a11">mem_tag_err</a>(<span class="keywordtype">void</span> *, <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>);       <span class="comment">/* Tag error */</span>
00085 <span class="preprocessor">#if defined(MEM_LIST)</span>
00086 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mshell_8c.html#a12">mem_list_add</a>(<a class="code" href="structmemnod.html">MEMHDR</a> *);         <span class="comment">/* Add block to list */</span>
00087 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mshell_8c.html#a13">mem_list_delete</a>(<a class="code" href="structmemnod.html">MEMHDR</a> *);      <span class="comment">/* Delete block from list */</span>
<a name="l00088"></a><a class="code" href="mshell_8c.html#a7">00088</a> <span class="preprocessor">#define Mem_Tag_Err(a)  mem_tag_err(a, fil, lin)</span>
00089 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#define Mem_Tag_Err(a)  mem_tag_err(a, __FILE__, __LINE__)</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00092 <span class="preprocessor"></span>
00093 
00094 <span class="comment">/**** Functions accessed only through macros ******************************/</span>
00095 
00096 <span class="comment">/*--------------------------------------------------------------------------</span>
00097 <span class="comment"> *</span>
00098 <span class="comment"> *  mem_alloc -- Allocate a memory block</span>
00099 <span class="comment"> *  Usage:</span>
00100 <span class="comment"> *      void *</span>
00101 <span class="comment"> *      mem_alloc(</span>
00102 <span class="comment"> *      size_t  size</span>
00103 <span class="comment"> *      )</span>
00104 <span class="comment"> *  Parameters: size    Size of block in bytes to allocate</span>
00105 <span class="comment"> *  Return Value: Pointer to allocated memory block, NULL if not</span>
00106 <span class="comment"> *      enough memory.</span>
00107 <span class="comment"> *  Description: mem_alloc() makes a protected call to malloc()</span>
00108 <span class="comment"> *  Notes: Access this routine using the malloc() macro in mshell.h</span>
00109 <span class="comment"> *</span>
00110 <span class="comment"> */</span>
00111 <span class="keywordtype">void</span> *
<a name="l00112"></a><a class="code" href="mshell_8c.html#a14">00112</a> <a class="code" href="mshell_8c.html#a14">mem_alloc</a>(
00113 #<span class="keywordflow">if</span> defined(<a class="code" href="mshell_8h.html#a1">MEM_WHERE</a>)
00114 size_t  size,
00115 <span class="keywordtype">char</span>    *fil,
00116 <span class="keywordtype">int</span>     lin
00117 #<span class="keywordflow">else</span>
00118 size_t  size
00119 #endif
00120 )
00121 
00122 {
00123 <a class="code" href="structmemnod.html">MEMHDR</a>  *p;
00124 
00125     <span class="comment">/* Allocate memory block */</span>
00126     p = <a class="code" href="mshell_8h.html#a6">calloc</a>(1, <a class="code" href="mshell_8c.html#a4">RESERVE_SIZE</a> + size);
00127     <span class="keywordflow">if</span> (p == NULL) {
00128         <span class="keywordflow">return</span> NULL;
00129     }
00130 
00131     <span class="comment">/* Init header */</span>
00132     p-&gt;<a class="code" href="structmemnod.html#m0">mh_tag</a> = <a class="code" href="mshell_8c.html#a1">MEMTAG</a>;
00133     p-&gt;<a class="code" href="structmemnod.html#m1">mh_size</a> = size;
00134     <a class="code" href="mshell_8c.html#a9">mem_size</a> += size;
00135 <span class="preprocessor">#if defined(MEM_WHERE)</span>
00136 <span class="preprocessor"></span>    p-&gt;<a class="code" href="structmemnod.html#m4">mh_file</a> = fil;
00137     p-&gt;<a class="code" href="structmemnod.html#m5">mh_line</a> = lin;
00138 <span class="preprocessor">#endif</span>
00139 <span class="preprocessor"></span>
00140 <span class="preprocessor">#if defined(MEM_LIST)</span>
00141 <span class="preprocessor"></span>    <a class="code" href="mshell_8c.html#a12">mem_list_add</a>(p);
00142 <span class="preprocessor">#endif</span>
00143 <span class="preprocessor"></span>
00144     <span class="comment">/* Return pointer to client data */</span>
00145     <span class="keywordflow">return</span> <a class="code" href="mshell_8c.html#a6">HDR_2_CLIENT</a>(p);
00146 }
00147 
00148 <span class="comment">/*--------------------------------------------------------------------------</span>
00149 <span class="comment"> *</span>
00150 <span class="comment"> *  mem_realloc -- Reallocate a memory block</span>
00151 <span class="comment"> *  Usage:</span>
00152 <span class="comment"> *      void *</span>
00153 <span class="comment"> *      mem_realloc(</span>
00154 <span class="comment"> *      void    *ptr,</span>
00155 <span class="comment"> *      size_t  size</span>
00156 <span class="comment"> *      )</span>
00157 <span class="comment"> *  Parameters: ptr     Pointer to current block</span>
00158 <span class="comment"> *              size    Size to adjust block to</span>
00159 <span class="comment"> *  Return value: Pointer to new memory block; NULL if memory cannot</span>
00160 <span class="comment"> *      be reallocated</span>
00161 <span class="comment"> *  Description: mem_realloc() makes a protected call to realloc().</span>
00162 <span class="comment"> *  Notes: Access this routine using the realloc() macro in mshell.h</span>
00163 <span class="comment"> *</span>
00164 <span class="comment"> */</span>
00165 
00166 <span class="keywordtype">void</span> *
<a name="l00167"></a><a class="code" href="mshell_8c.html#a15">00167</a> <a class="code" href="mshell_8c.html#a15">mem_realloc</a>(
00168 #<span class="keywordflow">if</span> defined(<a class="code" href="mshell_8h.html#a1">MEM_WHERE</a>)
00169 <span class="keywordtype">void</span>    *ptr,
00170 size_t  size,
00171 <span class="keywordtype">char</span>    *fil,
00172 <span class="keywordtype">int</span>     lin
00173 #<span class="keywordflow">else</span>
00174 <span class="keywordtype">void</span>    *ptr,
00175 size_t  size
00176 #endif
00177 )
00178 
00179 {
00180     <a class="code" href="structmemnod.html">MEMHDR</a>      *p;
00181 
00182     <span class="comment">/* Convert client pointer to header pointer */</span>
00183     p = <a class="code" href="mshell_8c.html#a5">CLIENT_2_HDR</a>(ptr);
00184 
00185     <span class="comment">/* Check for valid block */</span>
00186     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmemnod.html#m0">mh_tag</a> != <a class="code" href="mshell_8c.html#a1">MEMTAG</a>)
00187         {
00188         <a class="code" href="mshell_8c.html#a7">Mem_Tag_Err</a>(p);
00189         <span class="keywordflow">return</span> NULL;
00190         }
00191 
00192     <span class="comment">/* Invalidate header */</span>
00193     p-&gt;<a class="code" href="structmemnod.html#m0">mh_tag</a> = ~<a class="code" href="mshell_8c.html#a1">MEMTAG</a>;
00194     <a class="code" href="mshell_8c.html#a9">mem_size</a> -= p-&gt;<a class="code" href="structmemnod.html#m1">mh_size</a>;
00195 
00196 <span class="preprocessor">#if defined(MEM_LIST)</span>
00197 <span class="preprocessor"></span>    <a class="code" href="mshell_8c.html#a13">mem_list_delete</a>(p);         <span class="comment">/* Remove block from list */</span>
00198 <span class="preprocessor">#endif</span>
00199 <span class="preprocessor"></span>
00200     <span class="comment">/* Reallocate memory block */</span>
00201     p = (<a class="code" href="structmemnod.html">MEMHDR</a> *) <a class="code" href="mshell_8h.html#a3">realloc</a>(p, <a class="code" href="mshell_8c.html#a4">RESERVE_SIZE</a> + size);
00202     <span class="keywordflow">if</span> (p == NULL)
00203         {
00204         <span class="keywordflow">return</span> NULL;
00205         }
00206 
00207     <span class="comment">/* Update header */</span>
00208     p-&gt;<a class="code" href="structmemnod.html#m0">mh_tag</a> = <a class="code" href="mshell_8c.html#a1">MEMTAG</a>;
00209     p-&gt;<a class="code" href="structmemnod.html#m1">mh_size</a> = size;
00210     <a class="code" href="mshell_8c.html#a9">mem_size</a> += size;
00211 <span class="preprocessor">#if defined(MEM_WHERE)</span>
00212 <span class="preprocessor"></span>    p-&gt;<a class="code" href="structmemnod.html#m4">mh_file</a> = fil;
00213     p-&gt;<a class="code" href="structmemnod.html#m5">mh_line</a> = lin;
00214 <span class="preprocessor">#endif</span>
00215 <span class="preprocessor"></span>
00216 <span class="preprocessor">#if defined(MEM_LIST)</span>
00217 <span class="preprocessor"></span>    <a class="code" href="mshell_8c.html#a12">mem_list_add</a>(p);            <span class="comment">/* Add block to list */</span>
00218 <span class="preprocessor">#endif</span>
00219 <span class="preprocessor"></span>
00220     <span class="comment">/* Return pointer to client data */</span>
00221     <span class="keywordflow">return</span> <a class="code" href="mshell_8c.html#a6">HDR_2_CLIENT</a>(p);
00222 }
00223 
00224 <span class="comment">/*--------------------------------------------------------------------------</span>
00225 <span class="comment"> *</span>
00226 <span class="comment"> *  mem_strdup -- Save a string in dynamic memory</span>
00227 <span class="comment"> *  Usage:</span>
00228 <span class="comment"> *      char *</span>
00229 <span class="comment"> *      mem_strdup(</span>
00230 <span class="comment"> *      char    *str</span>
00231 <span class="comment"> *      )</span>
00232 <span class="comment"> *  Parameters: str     String to save</span>
00233 <span class="comment"> *  Return Value: Pointer to allocated string; NULL if not enough memory</span>
00234 <span class="comment"> *  Description: mem_strdup() saves specified string in dynamic memory.</span>
00235 <span class="comment"> *  Notes: Access this routine using strdup() macro in mshell.h</span>
00236 <span class="comment"> *</span>
00237 <span class="comment"> */</span>
00238 
00239 
00240 <span class="keywordtype">char</span> *
<a name="l00241"></a><a class="code" href="mshell_8c.html#a16">00241</a> <a class="code" href="mshell_8c.html#a16">mem_strdup</a>(
00242 #<span class="keywordflow">if</span> defined(<a class="code" href="mshell_8h.html#a1">MEM_WHERE</a>)
00243 <span class="keywordtype">char</span>    *str,
00244 <span class="keywordtype">char</span>    *fil,
00245 <span class="keywordtype">int</span>     lin
00246 #<span class="keywordflow">else</span>
00247 <span class="keywordtype">char</span>    *str
00248 #endif
00249 )
00250 
00251 {
00252     <span class="keywordtype">char</span> *s;
00253 
00254 <span class="preprocessor">#if defined(MEM_WHERE)</span>
00255 <span class="preprocessor"></span>    s = <a class="code" href="mshell_8c.html#a14">mem_alloc</a>(strlen(str)+1, fil, lin);
00256 <span class="preprocessor">#else</span>
00257 <span class="preprocessor"></span>    s = <a class="code" href="mshell_8c.html#a14">mem_alloc</a>(strlen(str)+1);
00258 <span class="preprocessor">#endif</span>
00259 <span class="preprocessor"></span>
00260     <span class="keywordflow">if</span> (s != NULL)
00261         {
00262         strcpy(s, str);
00263         }
00264 
00265 
00266     <span class="keywordflow">return</span> s;
00267 
00268 }
00269 
00270 <span class="comment">/*--------------------------------------------------------------------------</span>
00271 <span class="comment"> *</span>
00272 <span class="comment"> *  mem_free -- Free a memory block</span>
00273 <span class="comment"> *  Usage:</span>
00274 <span class="comment"> *      void</span>
00275 <span class="comment"> *      mem_free(</span>
00276 <span class="comment"> *      void    *ptr</span>
00277 <span class="comment"> *      )</span>
00278 <span class="comment"> *  Parameters: ptr     Pointer to memory to free</span>
00279 <span class="comment"> *  Description: mem_free() frees specified memory block. The block must</span>
00280 <span class="comment"> *  be allocated using mem_alloc(), mem_realloc() or mem_strdup().</span>
00281 <span class="comment"> *  Notes: Access this routine using the free() macro in mshell.h</span>
00282 <span class="comment"> *</span>
00283 <span class="comment"> */</span>
00284 
00285 <span class="keywordtype">void</span>
<a name="l00286"></a><a class="code" href="mshell_8c.html#a17">00286</a> <a class="code" href="mshell_8c.html#a17">mem_free</a>(
00287 #<span class="keywordflow">if</span> defined(<a class="code" href="mshell_8h.html#a1">MEM_WHERE</a>)
00288 <span class="keywordtype">void</span>    *ptr,
00289 <span class="keywordtype">char</span>    *fil,
00290 <span class="keywordtype">int</span>     lin
00291 #<span class="keywordflow">else</span>
00292 <span class="keywordtype">void</span>    *ptr
00293 #endif
00294 )
00295 
00296 {
00297     <a class="code" href="structmemnod.html">MEMHDR</a>      *p;
00298 
00299     <span class="comment">/* Convert client pointer to header pointer */</span>
00300     p = <a class="code" href="mshell_8c.html#a5">CLIENT_2_HDR</a>(ptr);
00301 
00302     <span class="comment">/* Check for valid block */</span>
00303     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmemnod.html#m0">mh_tag</a> != <a class="code" href="mshell_8c.html#a1">MEMTAG</a>)
00304         {
00305         <a class="code" href="mshell_8c.html#a7">Mem_Tag_Err</a>(p);
00306         <span class="keywordflow">return</span>;
00307         }
00308 
00309     <span class="comment">/* Invalidate header */</span>
00310     p-&gt;<a class="code" href="structmemnod.html#m0">mh_tag</a> = ~<a class="code" href="mshell_8c.html#a1">MEMTAG</a>;
00311     <a class="code" href="mshell_8c.html#a9">mem_size</a> -= p-&gt;<a class="code" href="structmemnod.html#m1">mh_size</a>;
00312 
00313 <span class="preprocessor">#if defined(MEM_LIST)</span>
00314 <span class="preprocessor"></span>    <a class="code" href="mshell_8c.html#a13">mem_list_delete</a>(p);         <span class="comment">/* Remove block from list */</span>
00315 <span class="preprocessor">#endif</span>
00316 <span class="preprocessor"></span>
00317     <span class="comment">/* Free memory block */</span>
00318     <a class="code" href="mshell_8h.html#a4">free</a>(p);
00319 }
00320 
00321 
00322 <span class="comment">/**** Functions accessed directly *****************************************/</span>
00323 
00324 <span class="comment">/*--------------------------------------------------------------------------</span>
00325 <span class="comment"> *</span>
00326 <span class="comment"> *  Mem_Used -- Return amount of memory currently allocated</span>
00327 <span class="comment"> *  Usage:</span>
00328 <span class="comment"> *      unsigned long</span>
00329 <span class="comment"> *      Mem_Used(</span>
00330 <span class="comment"> *      )</span>
00331 <span class="comment"> *  Parameters: None.</span>
00332 <span class="comment"> *  Description: Mem_Used() return number of bytes currently allocated</span>
00333 <span class="comment"> *      using the memory management system. Value returned is simply the</span>
00334 <span class="comment"> *      sum of the size requests to allocation routines; does not reflect</span>
00335 <span class="comment"> *      any overhead required by the memory management system.</span>
00336 <span class="comment"> *  Notes: None.</span>
00337 <span class="comment"> *</span>
00338 <span class="comment"> */</span>
00339 
00340 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>
<a name="l00341"></a><a class="code" href="mshell_8c.html#a18">00341</a> <a class="code" href="mshell_8c.html#a18">Mem_Used</a>(
00342 <span class="keywordtype">void</span>)
00343 
00344 {
00345     <span class="keywordflow">return</span> <a class="code" href="mshell_8c.html#a9">mem_size</a>;
00346 }
00347 
00348 <span class="comment">/*--------------------------------------------------------------------------</span>
00349 <span class="comment"> *</span>
00350 <span class="comment"> *  Mem_Display -- Display memory allocation list</span>
00351 <span class="comment"> *  Usage:</span>
00352 <span class="comment"> *      void</span>
00353 <span class="comment"> *      Mem_Display(</span>
00354 <span class="comment"> *      FILE    *fp</span>
00355 <span class="comment"> *      )</span>
00356 <span class="comment"> *  Parameters: fp      File to output data to</span>
00357 <span class="comment"> *  Description: Mem_Display() displays contents of memory allocation</span>
00358 <span class="comment"> *      list. This function is a no-op if MEM_LIST is not defined.</span>
00359 <span class="comment"> *  Notes: none.</span>
00360 <span class="comment"> *</span>
00361 <span class="comment"> */</span>
00362 
00363 <span class="keywordtype">void</span>
<a name="l00364"></a><a class="code" href="mshell_8c.html#a19">00364</a> <a class="code" href="mshell_8c.html#a19">Mem_Display</a>(
00365 FILE    *fp
00366 )
00367 
00368 {
00369 <span class="preprocessor">#if defined(MEM_LIST)</span>
00370 <span class="preprocessor"></span>    <a class="code" href="structmemnod.html">MEMHDR</a>      *p;
00371     <span class="keywordtype">int</span>         idx;
00372 
00373 <span class="preprocessor">#if defined(MEM_WHERE)</span>
00374 <span class="preprocessor"></span>    fprintf(fp, <span class="stringliteral">"Index    Size    File(Line) - total size %lu\n"</span>, <a class="code" href="mshell_8c.html#a9">mem_size</a>);
00375 <span class="preprocessor">#else</span>
00376 <span class="preprocessor"></span>    fprintf(fp, <span class="stringliteral">"Index    Size - total size %lu\n"</span>, <a class="code" href="mshell_8c.html#a9">mem_size</a>);
00377 <span class="preprocessor">#endif</span>
00378 <span class="preprocessor"></span>
00379     idx = 0;
00380     p = memlist;
00381     <span class="keywordflow">while</span> (p != NULL)
00382         {
00383         fprintf(fp, <span class="stringliteral">"%-5d %6u"</span>, idx++, p-&gt;<a class="code" href="structmemnod.html#m1">mh_size</a>);
00384 <span class="preprocessor">#if defined(MEM_WHERE)</span>
00385 <span class="preprocessor"></span>        fprintf(fp, <span class="stringliteral">"    %s(%d) "</span>, p-&gt;<a class="code" href="structmemnod.html#m4">mh_file</a>, p-&gt;<a class="code" href="structmemnod.html#m5">mh_line</a>);
00386 <span class="preprocessor">#endif</span>
00387 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmemnod.html#m0">mh_tag</a> != <a class="code" href="mshell_8c.html#a1">MEMTAG</a>)
00388             {
00389             fprintf(fp, <span class="stringliteral">"INVALID"</span>);
00390             }
00391         fprintf(fp, <span class="stringliteral">"\n"</span>);
00392         p = p-&gt;<a class="code" href="structmemnod.html#m2">mh_next</a>;
00393     }
00394 
00395 <span class="preprocessor">#else</span>
00396 <span class="preprocessor"></span>    fprintf(fp, <span class="stringliteral">"Memory list not compiled (MEM_LIST not defined)\n"</span>);
00397 
00398 <span class="preprocessor">#endif</span>
00399 <span class="preprocessor"></span>}
00400 
00401 <span class="comment">/**** Memory list manipulation functions **********************************/</span>
00402 
00403 <span class="comment">/*------------------------------------------------------------------------*/</span>
00404 <span class="comment">/* mem_list_add() -- Add block to list */</span>
00405 
00406 <span class="preprocessor">#if defined(MEM_LIST)</span>
00407 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00408"></a><a class="code" href="mshell_8c.html#a12">00408</a> <a class="code" href="mshell_8c.html#a12">mem_list_add</a>(
00409 <a class="code" href="structmemnod.html">MEMHDR</a> *p
00410 )
00411 
00412 {
00413     p-&gt;<a class="code" href="structmemnod.html#m2">mh_next</a> = memlist;
00414     p-&gt;<a class="code" href="structmemnod.html#m3">mh_prev</a> = NULL;
00415     <span class="keywordflow">if</span> (memlist != NULL)
00416         {
00417         memlist-&gt;<a class="code" href="structmemnod.html#m3">mh_prev</a> = p;
00418         }
00419     memlist = p;
00420 
00421 <span class="preprocessor">#if defined(DEBUG_LIST)</span>
00422 <span class="preprocessor"></span>    printf(<span class="stringliteral">"mem_list_add()\n"</span>);
00423     <a class="code" href="mshell_8c.html#a19">Mem_Display</a>(stdout);
00424 <span class="preprocessor">#endif</span>
00425 <span class="preprocessor"></span>}
00426 <span class="preprocessor">#endif</span>
00427 <span class="preprocessor"></span>
00428 <span class="comment">/*------------------------------------------------------------------------*/</span>
00429 <span class="comment">/* mem_list_delete() -- Delete block from list */</span>
00430 
00431 <span class="preprocessor">#if defined(MEM_LIST)</span>
00432 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00433"></a><a class="code" href="mshell_8c.html#a13">00433</a> <a class="code" href="mshell_8c.html#a13">mem_list_delete</a>(
00434 <a class="code" href="structmemnod.html">MEMHDR</a>  *p
00435 )
00436 
00437 {
00438     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmemnod.html#m2">mh_next</a> != NULL)
00439         {
00440         p-&gt;<a class="code" href="structmemnod.html#m2">mh_next</a>-&gt;<a class="code" href="structmemnod.html#m3">mh_prev</a> = p-&gt;<a class="code" href="structmemnod.html#m3">mh_prev</a>;
00441         }
00442     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structmemnod.html#m3">mh_prev</a> != NULL)
00443         {
00444         p-&gt;<a class="code" href="structmemnod.html#m3">mh_prev</a>-&gt;<a class="code" href="structmemnod.html#m2">mh_next</a> = p-&gt;<a class="code" href="structmemnod.html#m2">mh_next</a>;
00445         }
00446     <span class="keywordflow">else</span>
00447         {
00448         memlist = p-&gt;<a class="code" href="structmemnod.html#m2">mh_next</a>;
00449         }
00450 
00451 <span class="preprocessor">#if defined(DEBUG_LIST)</span>
00452 <span class="preprocessor"></span>    printf(<span class="stringliteral">"mem_list_delete()\n"</span>);
00453     <a class="code" href="mshell_8c.html#a19">Mem_Display</a>(stdout);
00454 <span class="preprocessor">#endif</span>
00455 <span class="preprocessor"></span>}
00456 <span class="preprocessor">#endif</span>
00457 <span class="preprocessor"></span>
00458 <span class="comment">/**** Error Display *******************************************************/</span>
00459 
00460 <span class="comment">/*------------------------------------------------------------------------*/</span>
00461 <span class="comment">/* mem_tag_err() -- Display memory tag error */</span>
00462 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00463"></a><a class="code" href="mshell_8c.html#a11">00463</a> <a class="code" href="mshell_8c.html#a11">mem_tag_err</a>(
00464 <span class="keywordtype">void</span>    *p,
00465 <span class="keywordtype">char</span>    *fil,
00466 <span class="keywordtype">int</span>     lin
00467 )
00468 
00469 {
00470     fprintf(stderr, <span class="stringliteral">"Memory tag error - %p - %s(%d)\n"</span>, p, fil, lin);
00471 <span class="preprocessor">#if defined (MEM_LIST)</span>
00472 <span class="preprocessor"></span>    <a class="code" href="mshell_8c.html#a19">Mem_Display</a>(stderr);
00473 <span class="preprocessor">#endif</span>
00474 <span class="preprocessor"></span>    exit(1);
00475 }
00476 
00477 <span class="comment">/*------------------------------------------------------------------------*/</span>
00478 
</pre></div><hr><address style="align: right;"><small>Generated on Fri Mar 5 19:26:48 2004 for MATRIXCALCULUS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
