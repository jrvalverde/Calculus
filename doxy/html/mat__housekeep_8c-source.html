<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mat_housekeep.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>mat_housekeep.c</h1><a href="mat__housekeep_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/**</span>
00002 <span class="comment"> *  @file   mat_housekeep.c</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> *  @brief  Routines for creating/destroying 2D matrices.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *  This module defines the routines used for creating and destroying</span>
00007 <span class="comment"> *  bidimensional matrices used for 2D matrix calculus. This is the </span>
00008 <span class="comment"> *  starting point before doing any worthy work.</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> *  In order to manipulate matrices using the libmatrix library, you</span>
00011 <span class="comment"> *  need to housekeep them with the routines provided in this module.</span>
00012 <span class="comment"> *  The library uses a special implementation in order to allow for</span>
00013 <span class="comment"> *  easy and efficient matrix manipulation: to achieve this, special,</span>
00014 <span class="comment"> *  additional information is added to the matrix data type. For this</span>
00015 <span class="comment"> *  reason you should always create and destroy 2D-matrices using the</span>
00016 <span class="comment"> *  routines provided.</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> *  An interesting side effect is that by using these routines and the</span>
00019 <span class="comment"> *  ones provided in the matrix_access module you do not need to be</span>
00020 <span class="comment"> *  aware of the internals of the implementation: not only means this</span>
00021 <span class="comment"> *  less mnemonic effort, it also gives the implementer more freedom</span>
00022 <span class="comment"> *  to adapt the implementation in the future without any need to</span>
00023 <span class="comment"> *  affect your programs, thus increasing maintainability.</span>
00024 <span class="comment"> *</span>
00025 <span class="comment"> *  Right now, two implementations are provided, one is more straightforward</span>
00026 <span class="comment"> *  and easier to understand and maintain, while the other should help</span>
00027 <span class="comment"> *  yield some speed increases in some very frequent operations. You</span>
00028 <span class="comment"> *  can select which one is used at compile time by defining </span>
00029 <span class="comment"> *  MAT_OPTIMIZE.</span>
00030 <span class="comment"> *</span>
00031 <span class="comment"> *  @pre    matrix.h</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> *  @see    matrix.h to learn about the definition of a </span>
00034 <span class="comment"> *          2D-matrix and the additional housekeeping information used to</span>
00035 <span class="comment"> *          better understand this module.</span>
00036 <span class="comment"> *</span>
00037 <span class="comment"> *  @see    mat_access.c once you know how to create/destroy bi-dimensional </span>
00038 <span class="comment"> *          matrices, you may procceed to learn more about how to obtain</span>
00039 <span class="comment"> *          various bits of information about your matrices and access its</span>
00040 <span class="comment"> *          data.</span>
00041 <span class="comment"> *</span>
00042 <span class="comment"> *  @see    mat_test.c to view some examples on using this code and</span>
00043 <span class="comment"> *          obtain debugging information.</span>
00044 <span class="comment"> *</span>
00045 <span class="comment"> *  @author José Ramón Valverde Carrillo    (jrvalverde@acm.org)</span>
00046 <span class="comment"> *</span>
00047 <span class="comment"> *  @version    3.0</span>
00048 <span class="comment"> *</span>
00049 <span class="comment"> *  @date   23 - february - 2004    v3.0</span>
00050 <span class="comment"> *</span>
00051 <span class="comment"> *  @date   11 - february - 2004    v2.0</span>
00052 <span class="comment"> *</span>
00053 <span class="comment"> *  @date    1 - october - 1988     Last modification of v1.0</span>
00054 <span class="comment"> *</span>
00055 <span class="comment"> *      COPYRIGHT:</span>
00056 <span class="comment"> *          © YoEgo.    Since I have no cash, I can't</span>
00057 <span class="comment"> *      register this (nor do I believe I should). So</span>
00058 <span class="comment"> *      this module is left in the PUBLIC DOMAIN.</span>
00059 <span class="comment"> *          It is furthermore forbidden its use for</span>
00060 <span class="comment"> *      commercial purposes unless I get a share on</span>
00061 <span class="comment"> *      the profits.</span>
00062 <span class="comment"> *          I say.</span>
00063 <span class="comment"> *                                              YoEgo.</span>
00064 <span class="comment"> *</span>
00065 <span class="comment"> * $Id$</span>
00066 <span class="comment"> * $Log$</span>
00067 <span class="comment"> */</span>
00068 
00069 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00070 <span class="preprocessor">#include &lt;math.h&gt;</span>
00071 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00072 <span class="preprocessor">#include &lt;bits/nan.h&gt;</span>
00073 
00074 <span class="preprocessor">#include "<a class="code" href="portable_8h.html">portable.h</a>"</span>
00075 <span class="preprocessor">#include "<a class="code" href="matrix_8h.html">matrix.h</a>"</span>
00076 
00077 <span class="comment">/*----------------------------------------------------------------*/</span>
00078 <span class="comment">/*                      MEMORY MANAGEMENT                         */</span>
00079 <span class="comment">/*----------------------------------------------------------------*/</span>
00080 <span class="comment"></span>
00081 <span class="comment">/** @defgroup matrix_housekeeping </span>
00082 <span class="comment"> * @{ </span>
00083 <span class="comment"> */</span>
00084 <span class="comment"></span>
00085 <span class="comment">/**</span>
00086 <span class="comment"> *  @fn public status mat_alloc(matrix *pmat, int rows, int cols);</span>
00087 <span class="comment"> *</span>
00088 <span class="comment"> *  @brief Allocate a new, uninitialized 2-D matrix</span>
00089 <span class="comment"> *</span>
00090 <span class="comment"> *  Allocates memory space for a bidimensional matrix</span>
00091 <span class="comment"> *  of 1..rows x 1..cols elements</span>
00092 <span class="comment"> *</span>
00093 <span class="comment"> *  @param pmat     address of the matrix to allocate</span>
00094 <span class="comment"> *  @param rows     the number of rows in the 2D-matrix</span>
00095 <span class="comment"> *  @param cols     the number of columns in the 2D-matrix</span>
00096 <span class="comment"> *</span>
00097 <span class="comment"> *  @return         success if all went well, an error code otherwise</span>
00098 <span class="comment"> *</span>
00099 <span class="comment"> *  @note   if MAT_PARANOIA has been defined, parameter checking is performed</span>
00100 <span class="comment"> */</span>
00101 
<a name="l00102"></a><a class="code" href="mat__housekeep_8c.html#a0">00102</a> <span class="keyword">public</span> <a class="code" href="portable_8h.html#a78">status</a> <a class="code" href="mat__housekeep_8c.html#a0">mat_alloc</a>(<a class="code" href="structmatrix.html">matrix</a> *pmat, <span class="keywordtype">int</span> rows, <span class="keywordtype">int</span> cols)
00103 {
00104     <span class="keyword">auto</span> <span class="keywordtype">int</span> i, j;
00105     <span class="keyword">auto</span> <a class="code" href="matrix_8h.html#a5">real</a> **row_vector;
00106     <span class="keyword">auto</span> <a class="code" href="matrix_8h.html#a5">real</a> *this_row;
00107     <a class="code" href="structmatrix.html">matrix</a> mat;
00108 
00109     *pmat = NULL;
00110 <span class="preprocessor">#   ifdef MAT_PARANOIA</span>
00111 <span class="preprocessor"></span>    <span class="comment">/* Check dimensions for validity */</span>
00112     <span class="keywordflow">if</span> ((rows &lt;= 0) || (cols &lt;= 0)) {
00113         <span class="keywordflow">return</span> <a class="code" href="matrix_8h.html#a2">MAT_BOUNDSCHECK</a>;
00114     }
00115 <span class="preprocessor">#   endif</span>
00116 <span class="preprocessor"></span>
00117     <span class="comment">/* allocate structure */</span>
00118     mat = (matrix) <a class="code" href="mshell_8h.html#a2">malloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structmatrix.html">matrix</a>));
00119     <span class="keywordflow">if</span> (mat == NULL)
00120         <span class="keywordflow">return</span> <a class="code" href="matrix_8h.html#a1">MAT_NOMEMORY</a>;
00121 
00122     <span class="comment">/* allocate array of vectors */</span>
00123     <span class="keywordflow">if</span> ((row_vector = <a class="code" href="mshell_8h.html#a2">malloc</a>(rows * <span class="keyword">sizeof</span>(<a class="code" href="matrix_8h.html#a5">real</a> *))) == NULL) {
00124         <a class="code" href="mshell_8h.html#a4">free</a>(mat);
00125         <span class="keywordflow">return</span> <a class="code" href="matrix_8h.html#a1">MAT_NOMEMORY</a>;
00126     }
00127     <span class="comment">/* make one-offset */</span>
00128     row_vector--;
00129     mat-&gt;<a class="code" href="structmatrix.html#m2">values</a> = row_vector;
00130 
00131 <span class="preprocessor">#   ifndef MAT_OPTIMIZE</span>
00132 <span class="preprocessor"></span>    <span class="comment">/* allocate each and every vector */</span>
00133     <span class="keywordflow">for</span> (i = 1; i &lt;= rows; i++) {
00134         <span class="keywordflow">if</span> ((this_row = <a class="code" href="mshell_8h.html#a2">malloc</a>(cols * <span class="keyword">sizeof</span>(<a class="code" href="matrix_8h.html#a5">real</a>))) == NULL) {
00135             <span class="comment">/* roll back and free any allocated vectors */</span>
00136             <span class="keywordflow">for</span> (j = i - 1; j &gt;= 1; j--) {
00137                 <span class="comment">/* this shouldn't execute if initially i == 1 */</span>
00138                 this_row = mat-&gt;<a class="code" href="structmatrix.html#m2">values</a>[j];
00139                 <span class="comment">/* make row zero-offset */</span>
00140                 this_row++;
00141                 <a class="code" href="mshell_8h.html#a4">free</a>(this_row);
00142             }
00143             row_vector = mat-&gt;<a class="code" href="structmatrix.html#m2">values</a>;
00144             row_vector++;
00145             <a class="code" href="mshell_8h.html#a4">free</a>(row_vector);
00146             <a class="code" href="mshell_8h.html#a4">free</a>(mat);
00147             <span class="keywordflow">return</span> <a class="code" href="matrix_8h.html#a1">MAT_NOMEMORY</a>;
00148         }
00149         <span class="comment">/* make row one-offset */</span>
00150         this_row--;
00151         mat-&gt;<a class="code" href="structmatrix.html#m2">values</a>[i] = this_row;
00152     }
00153 <span class="preprocessor">#   else</span>
00154 <span class="preprocessor"></span>    <span class="comment">/* trick: we allocate all rows at once */</span>
00155     <span class="keywordflow">if</span> ((this_row = <a class="code" href="mshell_8h.html#a2">malloc</a>(rows * cols * <span class="keyword">sizeof</span>(<a class="code" href="matrix_8h.html#a5">real</a>))) == NULL) {
00156         <a class="code" href="mshell_8h.html#a4">free</a>(mat-&gt;<a class="code" href="structmatrix.html#m2">values</a>);
00157         <a class="code" href="mshell_8h.html#a4">free</a>(mat);
00158         <span class="keywordflow">return</span> <a class="code" href="matrix_8h.html#a1">MAT_NOMEMORY</a>;
00159     }
00160     <span class="comment">/* make zero-offset */</span>
00161     this_row--;
00162     <span class="keywordflow">for</span> (i = 1; i &lt;= rows; i++) {
00163         <span class="comment">/* compute address of each row */</span>
00164         <span class="comment">/* this should be much faster than allocating each separately */</span>
00165         <span class="comment">/* and will allow for other speed-ups */</span>
00166         mat-&gt;<a class="code" href="structmatrix.html#m2">values</a>[i] = this_row;
00167         this_row += cols;
00168     }
00169 <span class="preprocessor">#   endif</span>
00170 <span class="preprocessor"></span>
00171     <span class="comment">/* fill in matrix dimensions */</span>
00172     mat-&gt;<a class="code" href="structmatrix.html#m0">rows</a> = rows;
00173     mat-&gt;<a class="code" href="structmatrix.html#m1">cols</a> = cols;
00174 
00175     *pmat = mat;
00176     <span class="keywordflow">return</span> <a class="code" href="portable_8h.html#a65">SUCCESS</a>;
00177 }
00178 <span class="comment"></span>
00179 <span class="comment">/**</span>
00180 <span class="comment"> *  @fn public void mat_free(matrix mat)</span>
00181 <span class="comment"> *</span>
00182 <span class="comment"> *  @brief free a 2D-matrix</span>
00183 <span class="comment"> *</span>
00184 <span class="comment"> *  @param mat  the matrix to be freed, must have been allocated by mat_alloc()</span>
00185 <span class="comment"> *</span>
00186 <span class="comment"> *  @return SUCCESS if all went well</span>
00187 <span class="comment"> */</span>
<a name="l00188"></a><a class="code" href="mat__housekeep_8c.html#a1">00188</a> <span class="keyword">public</span> <a class="code" href="portable_8h.html#a78">status</a> <a class="code" href="mat__housekeep_8c.html#a1">mat_free</a>(<a class="code" href="structmatrix.html">matrix</a> mat)
00189 {
00190     <span class="keywordtype">int</span> i, maxrow;
00191     <a class="code" href="matrix_8h.html#a5">real</a> *row;
00192     <a class="code" href="matrix_8h.html#a5">real</a> **rows_vector;
00193 
00194     <span class="keywordflow">if</span> (mat == NULL)
00195         <span class="keywordflow">return</span> <a class="code" href="portable_8h.html#a65">SUCCESS</a>;
00196 
00197     <span class="comment">/* NOTE: mat should have been allocated through mat_alloc */</span>
00198     <span class="comment">/* if not, or if mat-&gt;rows is corrupted, this will bomb out */</span>
00199     maxrow = mat-&gt;<a class="code" href="structmatrix.html#m0">rows</a>;
00200 <span class="preprocessor">#   ifndef MAT_OPTIMIZE</span>
00201 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i = 1; i &lt;= maxrow; i++) {
00202         row = mat-&gt;<a class="code" href="structmatrix.html#m2">values</a>[i];
00203         row++;
00204         <a class="code" href="mshell_8h.html#a4">free</a>(row);
00205     }
00206 <span class="preprocessor">#   else</span>
00207 <span class="preprocessor"></span>    <span class="comment">/* we allocated the entire matrix as a single array */</span>
00208     row = mat-&gt;<a class="code" href="structmatrix.html#m2">values</a>[1];
00209     row++;
00210     <a class="code" href="mshell_8h.html#a4">free</a>(row);
00211 <span class="preprocessor">#   endif</span>
00212 <span class="preprocessor"></span>    rows_vector = mat-&gt;<a class="code" href="structmatrix.html#m2">values</a>;
00213     rows_vector++;
00214     <a class="code" href="mshell_8h.html#a4">free</a>(rows_vector);
00215     <a class="code" href="mshell_8h.html#a4">free</a>(mat);
00216     <span class="keywordflow">return</span> <a class="code" href="portable_8h.html#a65">SUCCESS</a>;
00217 }
00218 <span class="comment"></span>
00219 <span class="comment">/** @} */</span>
00220 
</pre></div><hr><address style="align: right;"><small>Generated on Fri Mar 5 19:26:48 2004 for MATRIXCALCULUS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
